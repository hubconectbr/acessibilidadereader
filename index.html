<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor Neural V13 - Demo Jur√≠dica</title>
    <style>
        :root {
            --primary: #00f3ff; --danger: #ff0055; --success: #00ff66;
            --locked: #ffaa00; --inactive: #333; --bg: #050505;
            --glass: rgba(15, 20, 30, 0.95);
        }
        body { margin: 0; overflow: hidden; background-color: var(--bg); font-family: 'Segoe UI', monospace; color: white; }

        /* SETUP LAYER */
        #setup-layer {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: radial-gradient(circle at center, #112 0%, #000 100%);
            z-index: 2000; display: flex; align-items: center; justify-content: center;
            transition: top 0.8s cubic-bezier(0.7, 0, 0.3, 1);
        }
        .dashboard {
            display: grid; grid-template-columns: 1fr 1.2fr; gap: 30px;
            width: 950px; height: 620px; 
            background: rgba(20, 20, 25, 0.9); border: 1px solid rgba(0, 243, 255, 0.2);
            box-shadow: 0 0 60px rgba(0, 243, 255, 0.05); border-radius: 20px; padding: 40px; position: relative;
        }
        h2 { color: var(--primary); margin: 0 0 10px 0; font-weight: 300; letter-spacing: 2px; text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 5px; font-size: 1rem; }

        /* UPLOAD ZONE */
        .upload-zone {
            border: 2px dashed #444; border-radius: 12px; height: 100px; margin-bottom: 10px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: 0.3s; cursor: pointer; background: rgba(0,0,0,0.3);
        }
        .upload-zone:hover { border-color: var(--primary); background: rgba(0, 243, 255, 0.05); }
        .upload-zone.valid { border-style: solid; border-color: var(--primary); background: rgba(0, 243, 255, 0.1); }
        .icon-upload { font-size: 1.5rem; margin-bottom: 5px; opacity: 0.7; }
        #file-input { display: none; }

        /* PROGRESSO */
        #progress-container { margin-bottom: 20px; display: none; width: 100%; }
        .progress-track { height: 6px; background: #111; border-radius: 3px; border: 1px solid #333; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background: var(--primary); box-shadow: 0 0 10px var(--primary); transition: width 0.1s linear; }
        .progress-txt { font-size: 0.7rem; color: var(--primary); text-align: right; margin-top: 3px; }

        /* TREINO */
        .training-container { background: #111; border-radius: 12px; padding: 15px; border: 1px solid #333; }
        .step-item { display: flex; align-items: center; margin-bottom: 8px; padding: 10px; background: #1a1a1a; border-radius: 6px; transition: 0.3s; border-left: 4px solid var(--inactive); opacity: 0.5; }
        .step-item.current { opacity: 1; background: #222; border-left-color: var(--locked); box-shadow: 0 0 10px rgba(255, 170, 0, 0.1); transform: translateX(10px); }
        .step-item.done { opacity: 1; background: rgba(0, 255, 102, 0.1); border-left-color: var(--success); }
        .step-num { font-weight: bold; font-size: 1rem; margin-right: 15px; width: 20px; }
        .step-text { flex-grow: 1; font-size: 0.85rem; color: #eee; }
        .step-icon { font-size: 1.2rem; }

        /* CAMERA */
        .cam-frame { flex-grow: 1; background: #000; border-radius: 8px; border: 1px solid #333; position: relative; overflow: hidden; }
        #intro-video, #tracking-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #tracking-canvas { z-index: 2; }
        .scan-line { position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: var(--primary); box-shadow: 0 0 15px var(--primary); animation: scan 2s infinite ease-in-out; opacity: 0.8; z-index: 3; }
        @keyframes scan { 0% { top: -10%; opacity:0; } 15% { opacity:1; } 85% { opacity:1; } 100% { top: 110%; opacity:0; } }
        
        /* NOVO: STATUS EM TEMPO REAL */
        #realtime-status {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.6);
            padding: 5px 10px;
            box-sizing: border-box;
            z-index: 4;
            font-size: 0.7rem;
            color: #ccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: monospace;
        }
        #status-blink {
            color: var(--primary);
            font-weight: bold;
            font-size: 0.8rem;
            letter-spacing: 1px;
        }
        #status-blink.detected {
            color: var(--danger);
            text-shadow: 0 0 5px var(--danger);
        }

        /* HUD */
        #top-bar { position: fixed; top: 0; left: 0; width: 100%; height: 70px; background: var(--glass); border-bottom: 2px solid var(--primary); display: none; z-index: 1000; align-items: center; justify-content: space-between; padding: 0 30px; box-sizing: border-box; backdrop-filter: blur(10px); transition: border-color 0.3s; }
        #top-bar.frozen { border-bottom-color: var(--locked); background: rgba(50, 30, 10, 0.95); }
        .bar-section { display: flex; align-items: center; gap: 20px; }
        
        .semaphore-container { position: relative; width: 300px; height: 10px; background: #222; border-radius: 5px; overflow: hidden; border: 1px solid #444; }
        #head-cursor { position: absolute; left: 50%; top: -3px; width: 16px; height: 16px; background: var(--success); border-radius: 50%; transform: translateX(-50%); box-shadow: 0 0 10px var(--success); transition: left 0.1s ease-out, background 0.2s; }
        .sem-center-marker { position: absolute; left: 50%; width: 2px; height: 100%; background: #555; transform: translateX(-50%); }

        #voice-status { font-size: 0.8rem; font-weight: bold; color: #666; display: flex; align-items: center; gap: 5px; }
        #voice-status.speaking { color: var(--primary); text-shadow: 0 0 5px var(--primary); }
        #lock-status { font-size: 1.5rem; color: var(--success); display: flex; align-items: center; gap: 5px; }
        #lock-status.locked { color: var(--locked); }
        .lock-text { font-size: 0.8rem; font-weight: bold; letter-spacing: 1px; }
        .status-light { width: 12px; height: 12px; border-radius: 50%; background: #333; margin-right: 5px; border: 1px solid #555; }
        .status-light.blink-l { background: var(--danger); box-shadow: 0 0 10px var(--danger); }
        .status-light.blink-r { background: var(--primary); box-shadow: 0 0 10px var(--primary); }

        #viewport { position: fixed; top: 70px; left: 0; right: 0; bottom: 0; background: #151515; overflow-y: scroll; scroll-behavior: smooth; }
        #pdf-container { width: 90%; max-width: 1200px; margin: 0 auto; padding-top: 40px; padding-bottom: 800px; transform-origin: top center; transition: transform 0.1s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        iframe { width: 100%; height: 2500px; border: none; background: white; border-radius: 4px; display: block; }
    
        /* MODIFICA√á√ïES - RESPONSIVIDADE MOBILE (Mobile First) */
        @media (max-width: 992px) {
            /* Garante a tela cheia para valida√ß√£o biom√©trica no celular */
            #setup-layer { 
                align-items: flex-start;
                overflow-y: auto;
            }
            .dashboard {
                grid-template-columns: 1fr; /* Coluna √∫nica */
                width: 100vw; /* Ocupa a largura total */
                height: auto;
                padding: 20px 10px;
                margin: 0;
                border-radius: 0;
                box-shadow: none;
            }
            .panel-right {
                order: -1; /* Move a c√¢mera para o topo */
                margin-bottom: 20px;
            }
            .cam-frame {
                height: 300px; /* Altura fixa para a c√¢mera no celular */
            }
            #top-bar {
                height: auto;
                padding: 10px 15px;
                flex-direction: column;
            }
            .bar-section {
                flex-wrap: wrap;
                justify-content: center;
            }
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
</head>
<body>

    <div id="setup-layer">
        <div class="dashboard">
            <div class="panel-left">
                <h2>2. Valida√ß√£o Biom√©trica</h2>
                <div class="training-container">
                    <div class="step-item current" id="step-1"><div class="step-num">1</div><div class="step-text">Pisque LADO DIREITO da Tela</div><div class="step-icon">üòâ</div></div>
                    <div class="step-item" id="step-2"><div class="step-num">2</div><div class="step-text">Pisque LADO ESQUERDO da Tela</div><div class="step-icon">üòâ</div></div>
                    <div class="step-item" id="step-3"><div class="step-num">3</div><div class="step-text">Pisque DUPLO (Treino)</div><div class="step-icon">üòë</div></div>
                    <div class="step-item" id="step-4"><div class="step-num">4</div><div class="step-text">Pisque DUPLO (Entrar)</div><div class="step-icon">üöÄ</div></div>
                </div>
                <div style="margin-top:10px; font-size:0.8rem; color:#666; text-align:center">Status: <span id="sys-status">Aguardando...</span></div>
            </div>

            <div class="panel-right" style="display: flex; flex-direction: column;">
                <h2>3. Monitoramento</h2>
                <div class="cam-frame">
                    <video id="intro-video" playsinline muted autoplay></video>
                    <canvas id="tracking-canvas"></canvas>
                    <div class="scan-line"></div>
                    <div id="realtime-status">
                        <div id="status-blink">Aguardando Captura</div>
                        <div id="status-data"></div>
                    </div>
                    </div>
                <div style="text-align: center; margin-top: 15px; font-size: 0.8rem; color: #888;">ABRA A BOCA PARA ATIVAR A LEITURA DA RESOLU√á√ÉO</div>
            </div>
        </div>
    </div>

    <div id="upload-layer" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: var(--bg); z-index: 1500; display: none; align-items: center; justify-content: center;">
        <div style="width: 90%; max-width: 500px; padding: 30px; background: rgba(20, 20, 25, 0.9); border-radius: 12px; border: 1px solid rgba(0, 243, 255, 0.2);">
            <h2>1. Documento Oficial</h2>
            <div class="upload-zone" id="drop-zone" onclick="document.getElementById('file-input').click()">
                <div id="upload-icon" class="icon-upload">üìÇ</div>
                <div id="upload-text">Selecionar PDF (Resolu√ß√£o 454)</div>
                <input type="file" id="file-input" accept=".pdf">
            </div>
            <div id="progress-container">
                <div class="progress-track"><div id="prog-fill" class="progress-fill"></div></div>
                <div id="prog-txt" class="progress-txt">0%</div>
            </div>
            <div style="margin-top:20px; font-size:0.8rem; color:#888; text-align:center">Valida√ß√£o biom√©trica conclu√≠da. Envie o documento para iniciar a leitura.</div>
        </div>
    </div>
    <div id="top-bar">
        <div class="bar-section">
            <div class="status-group"><div id="led-prev" class="status-light"></div> VOLTAR</div>
            <div class="status-group"><div id="led-next" class="status-light"></div> AVAN√áAR</div>
        </div>
        <div class="bar-section" style="flex-direction: column; gap: 5px;">
            <div id="lock-status"><span id="lock-icon">üîì</span> <span class="lock-text" id="lock-text">ATIVO</span></div>
            <div class="semaphore-container"><div class="sem-center-marker"></div><div id="head-cursor"></div></div>
        </div>
        <div class="bar-section">
            <div style="text-align: right;">
                <div id="voice-status">üó£Ô∏è LEITURA OFF</div>
                <div id="zoom-txt" style="color:var(--primary); font-weight:bold; font-size:1.2rem">100%</div>
            </div>
        </div>
    </div>

    <div id="viewport"><div id="pdf-container"><iframe id="pdf-frame" src=""></iframe></div></div>

    <script>
        // ======================================================
        // CONTE√öDO DA RESOLU√á√ÉO N¬∫ 454 (Para Demo de Voz)
        // ======================================================
        const TEXTO_DA_LEITURA = 
            "Resolu√ß√£o n√∫mero 4 5 4, de 23 de setembro de 2019. " +
            "O Tribunal Regional Eleitoral do Tocantins resolve instituir o C√≥digo de Conduta e Integridade. " +
            "Cap√≠tulo Um. Das disposi√ß√µes iniciais. Artigo Primeiro. " +
            "Instituir o C√≥digo de Conduta e Integridade do Tribunal Regional Eleitoral do Tocantins com o objetivo de: " +
            "Um: contribuir para o cumprimento da miss√£o, o alcance da vis√£o do Tribunal e consolidar os valores institucionais. " +
            "Dois: preservar a imagem da Justi√ßa Eleitoral do Estado do Tocantins e resguardar a reputa√ß√£o dos participantes deste c√≥digo. " +
            "Tr√™s: assegurar que a atua√ß√£o dos participantes observe os princ√≠pios e normas de conduta e integridade profissional. " +
            "Artigo Segundo. Este c√≥digo se aplica a todas as pessoas, f√≠sicas ou jur√≠dicas, que prestem servi√ßos ao Tribunal. " +
            "Cap√≠tulo Dois. Dos Princ√≠pios, Valores e Compromissos. " +
            "Artigo Quinto. O comportamento dos participantes baseia-se nos princ√≠pios da √©tica, respeito √† vida, dignidade humana, justi√ßa social e preval√™ncia do interesse p√∫blico.";

        // AREA PARA COLAR O PDF BASE64 (Opcional, se quiser carregar autom√°tico)
        const PDF_INTEGRADO = ""; 

        // CONFIGURA√á√ïES (VALORES ATUALIZADOS PARA CALIBRA√á√ÉO FINAL)
        const CONFIG = {
            SMOOTHING: 0.12, DEAD_ZONE: 0.06, SCROLL_SPEED: 80,
            BLINK_THRESH: 0.25, OPEN_THRESH: 0.26, // Calibra√ß√£o para m√°xima toler√¢ncia assim√©trica
            MOUTH_OPEN_THRESH: 0.06, MOUTH_CLOSE_THRESH: 0.03,
            ZOOM_TRIGGER: 0.42, ZOOM_MIN: 1.0, ZOOM_MAX: 1.35, DOUBLE_BLINK_INTERVAL: 900 
        };

        const STATE = { 
            active: false, frozen: false, pdfUrl: null, pdfIntegrated: false, 
            rawNoseY: 0, smoothNoseY: 0, targetScroll: 0, currentScale: 1.0, page: 1, 
            lastPageTime: 0, blinkBothCount: 0, lastBlinkBothTime: 0, isBlinkingBoth: false,
            isMouthOpen: false, readingActive: false, lastMouthTime: 0, trainingStep: 0 
        };

        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const sysStatus = document.getElementById('sys-status');
        const pdfFrame = document.getElementById('pdf-frame');
        const introVideo = document.getElementById('intro-video');
        const trackingCanvas = document.getElementById('tracking-canvas');
        const trackingCtx = trackingCanvas.getContext('2d');
        const headCursor = document.getElementById('head-cursor');
        const lockIcon = document.getElementById('lock-icon');
        const lockText = document.getElementById('lock-text');
        const topBar = document.getElementById('top-bar');
        const voiceStatus = document.getElementById('voice-status');
        const progressContainer = document.getElementById('progress-container');
        const progFill = document.getElementById('prog-fill');
        const progTxt = document.getElementById('prog-txt');
        const step1 = document.getElementById('step-1');
        const step2 = document.getElementById('step-2');
        const step3 = document.getElementById('step-3');
        const step4 = document.getElementById('step-4');
        
        // NOVAS REFER√äNCIAS DOM
        const statusBlink = document.getElementById('status-blink');
        const statusData = document.getElementById('status-data');


        window.onload = () => {
            if (PDF_INTEGRADO.length > 50) {
                STATE.pdfUrl = PDF_INTEGRADO;
                STATE.pdfIntegrated = true; // Marca como PDF integrado
                sysStatus.innerText = "Resolu√ß√£o Integrada. Valide a Biometria.";
                // Marca upload como feito visualmente no novo layer
                document.getElementById('upload-icon').innerText = "‚úÖ";
                document.getElementById('upload-text').innerText = "Resolu√ß√£o 454 (Integrada)";
                dropZone.classList.add('valid');
            }
            // Inicia a c√¢mera imediatamente para a valida√ß√£o biom√©trica
            initCamera();
        };

        fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.borderColor = '#00f3ff'; });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.style.borderColor = '#444'; });
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); handleFile(e.dataTransfer.files[0])); });

        function handleFile(file) {
            if(file && file.name.toLowerCase().endsWith('.pdf')) {
                progressContainer.style.display = "block"; progFill.style.width = "0%"; progTxt.innerText = "0%";
                document.getElementById('upload-text').innerText = "Carregando Documento...";
                let p = 0;
                const interval = setInterval(() => {
                    p += 8; progFill.style.width = p + "%"; progTxt.innerText = p + "%";
                    if(p >= 100) { clearInterval(interval); finalizeUpload(file); }
                }, 40);
            } else { alert("Selecione um PDF."); }
        }

        function finalizeUpload(file) {
            STATE.pdfUrl = URL.createObjectURL(file);
            document.getElementById('upload-icon').innerText = "‚úÖ";
            document.getElementById('upload-text').innerText = file.name;
            dropZone.classList.add('valid');
            
            // Inicia o leitor (HUD)
            launchReaderHUD();
            speak("Documento carregado. Leitor ativado.");
        }

        async function initCamera() {
            try {
                const faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
                faceMesh.setOptions({maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});
                faceMesh.onResults(onResults);
                const camera = new Camera(introVideo, {
                    onFrame: async () => { await faceMesh.send({image: introVideo}); },
                    width: 320, height: 240
                });
                await camera.start();
                sysStatus.innerText = "Sistema Ativo. Valide a Biometria.";
                // Instru√ß√£o inicial ajustada
                speak("Sistema iniciado. Por favor, pisque o olho do lado direito da tela para validar.");
            } catch (err) { sysStatus.innerText = "Erro: " + err.message; }
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'pt-BR';
                utterance.rate = 1.0; 
                window.speechSynthesis.speak(utterance);
            }
        }

        function toggleReading() {
            const now = Date.now();
            if (now - STATE.lastMouthTime < 2000) return;
            STATE.lastMouthTime = now;
            STATE.readingActive = !STATE.readingActive;
            
            if (STATE.readingActive) {
                voiceStatus.innerHTML = "üó£Ô∏è LENDO...";
                voiceStatus.classList.add('speaking');
                speak(TEXTO_DA_LEITURA); // L√™ o texto jur√≠dico
            } else {
                voiceStatus.innerHTML = "üó£Ô∏è LEITURA OFF";
                voiceStatus.classList.remove('speaking');
                window.speechSynthesis.cancel();
                speak("Leitura pausada.");
            }
        }

        function launchReaderHUD() {
            STATE.active = true;
            document.getElementById('upload-layer').style.display = "none"; // Esconde o Layer de Upload
            topBar.style.display = "flex"; // Mostra Top Bar
            
            // Carrega o PDF
            if (STATE.pdfUrl) {
                pdfFrame.src = STATE.pdfUrl + "#page=1";
            }
            
            animate();
        }

        function activateReader() {
            // Transi√ß√£o da tela de Valida√ß√£o para a tela de Upload/Leitura
            document.getElementById('setup-layer').style.top = "-100vh"; // Esconde Valida√ß√£o

            if (STATE.pdfIntegrated) {
                // Se o PDF for integrado (Base64), pula o upload e vai direto para o HUD
                launchReaderHUD(); 
                speak("Acesso autorizado. Leitura iniciada.");
            } else {
                // Se n√£o for integrado, mostra a tela de upload
                document.getElementById('upload-layer').style.display = "flex"; // Mostra Upload
                sysStatus.innerText = "Acesso autorizado. Por favor, carregue o PDF.";
                speak("Acesso autorizado. Por favor, carregue o documento oficial.");
            }
        }

        function onResults(results) {
            if(!STATE.active) {
                trackingCanvas.width = introVideo.videoWidth; trackingCanvas.height = introVideo.videoHeight;
                trackingCtx.save(); trackingCtx.clearRect(0, 0, trackingCanvas.width, trackingCanvas.height);
                if(results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                    const lm = results.multiFaceLandmarks[0];
                    drawConnectors(trackingCtx, lm, FACEMESH_TESSELATION, {color: '#00f3ff10', lineWidth: 1});
                    drawConnectors(trackingCtx, lm, FACEMESH_LIPS, {color: '#00f3ff', lineWidth: 2});
                    drawConnectors(trackingCtx, lm, FACEMESH_RIGHT_EYE, {color: '#00f3ff', lineWidth: 2});
                    drawConnectors(trackingCtx, lm, FACEMESH_LEFT_EYE, {color: '#00f3ff', lineWidth: 2});
                }
                trackingCtx.restore();
            }

            if(!results.multiFaceLandmarks || results.multiFaceLandmarks.length === 0) return;
            const face = results.multiFaceLandmarks[0];
            const now = Date.now();
            const dist = (p1, p2) => Math.sqrt((p1.x-p2.x)**2 + (p1.y-p2.y)**2);
            
            // Valores de EAR para o piscar de olhos
            const earL = (dist(face[159], face[145]) + dist(face[160], face[144])) / (2 * dist(face[33], face[133]));
            const earR = (dist(face[386], face[374]) + dist(face[385], face[375])) / (2 * dist(face[362], face[263]));
            const earAvg = (earL + earR) / 2;
            const noseY = face[1].y - 0.5;
            const faceHeight = dist(face[10], face[152]);
            const mouthOpen = dist(face[13], face[14]);
            const mouthRatio = mouthOpen / faceHeight;

            // ======================================================
            // ATUALIZA√á√ÉO DO STATUS EM TEMPO REAL (Para feedback imediato)
            // ======================================================
            if (statusData) {
                // Pisca a cor do valor se estiver abaixo do BLINK_THRESH
                statusData.innerHTML = `EAR L: <span style="color:${earL < CONFIG.BLINK_THRESH ? 'var(--danger)' : '#ccc'}">${earL.toFixed(2)}</span> | EAR R: <span style="color:${earR < CONFIG.BLINK_THRESH ? 'var(--danger)' : '#ccc'}">${earR.toFixed(2)}</span> | Boca: ${mouthRatio.toFixed(2)}`;
            }
            if (statusBlink) {
                let blinkStatus = "Ocular OK";
                let blinking = false;

                // Mostra o status de detec√ß√£o de piscar
                // O Passo 1 ('earL') mapeia para o LADO DIREITO DA TELA
                if (earL < CONFIG.BLINK_THRESH && earR > CONFIG.OPEN_THRESH) {
                    blinkStatus = "PISCANDO LADO DIREITO";
                    blinking = true;
                // O Passo 2 ('earR') mapeia para o LADO ESQUERDO DA TELA
                } else if (earR < CONFIG.BLINK_THRESH && earL > CONFIG.OPEN_THRESH) {
                    blinkStatus = "PISCANDO LADO ESQUERDO";
                    blinking = true;
                } else if (earAvg < CONFIG.BLINK_THRESH) {
                    blinkStatus = "PISCAR DUPLO DETECTADO";
                    blinking = true;
                }
                
                statusBlink.innerText = blinkStatus;
                statusBlink.classList.toggle('detected', blinking);
            }
            // ======================================================

            // TREINO
            if (!STATE.active) {
                if (STATE.trainingStep === 0) {
                    // Passo 1: Piscar Esquerdo do usu√°rio (LADO DIREITO DA TELA)
                    if (earL < CONFIG.BLINK_THRESH && earR > CONFIG.OPEN_THRESH) completeStep(1, step1, step2);
                } else if (STATE.trainingStep === 1) {
                    // Passo 2: Piscar Direito do usu√°rio (LADO ESQUERDO DA TELA)
                    if (earR < CONFIG.BLINK_THRESH && earL > CONFIG.OPEN_THRESH) completeStep(2, step2, step3);
                } else if (STATE.trainingStep === 2) {
                    // Passo 3: Piscar Duplo (Treino)
                    if (earAvg < CONFIG.BLINK_THRESH) { 
                        if (!STATE.isBlinkingBoth) {
                            STATE.isBlinkingBoth = true;
                            if (now - STATE.lastBlinkBothTime < CONFIG.DOUBLE_BLINK_INTERVAL) completeStep(3, step3, step4);
                            STATE.lastBlinkBothTime = now;
                        }
                    } else if (earAvg > CONFIG.OPEN_THRESH) STATE.isBlinkingBoth = false;
                } else if (STATE.trainingStep === 3) {
                    // Passo 4: Piscar Duplo (Entrar)
                    if (earAvg < CONFIG.BLINK_THRESH) {
                        if (!STATE.isBlinkingBoth) {
                            STATE.isBlinkingBoth = true;
                            if (now - STATE.lastBlinkBothTime < CONFIG.DOUBLE_BLINK_INTERVAL) {
                                completeStep(4, step4, null); setTimeout(activateReader, 800);
                            }
                            STATE.lastBlinkBothTime = now;
                        }
                    } else if (earAvg > CONFIG.OPEN_THRESH) STATE.isBlinkingBoth = false;
                }
                return;
            }

            // LEITURA
            if (earAvg < CONFIG.BLINK_THRESH) {
                if (!STATE.isBlinkingBoth) {
                    STATE.isBlinkingBoth = true;
                    if (now - STATE.lastBlinkBothTime < CONFIG.DOUBLE_BLINK_INTERVAL) toggleFreeze();
                    STATE.lastBlinkBothTime = now;
                }
            } else if (earAvg > CONFIG.OPEN_THRESH) STATE.isBlinkingBoth = false;

            if (mouthRatio > CONFIG.MOUTH_OPEN_THRESH) {
                if (!STATE.isMouthOpen) { STATE.isMouthOpen = true; toggleReading(); }
            } else if (mouthRatio < CONFIG.MOUTH_CLOSE_THRESH) { STATE.isMouthOpen = false; }

            STATE.smoothNoseY = (1 - CONFIG.SMOOTHING) * STATE.smoothNoseY + CONFIG.SMOOTHING * noseY;

            if (STATE.frozen) {
                STATE.targetScroll = 0; headCursor.style.background = "#ffaa00";
            } else {
                if (Math.abs(STATE.smoothNoseY) > CONFIG.DEAD_ZONE) {
                    const dir = Math.sign(STATE.smoothNoseY);
                    const val = Math.abs(STATE.smoothNoseY) - CONFIG.DEAD_ZONE;
                    STATE.targetScroll = dir * val * CONFIG.SCROLL_SPEED;
                    let vPos = 50 + (STATE.smoothNoseY * 300); 
                    headCursor.style.left = Math.max(10, Math.min(90, vPos)) + "%";
                    headCursor.style.background = dir > 0 ? "#00f3ff" : "#ff0055";
                } else {
                    STATE.targetScroll = 0; headCursor.style.left = "50%"; headCursor.style.background = "#00ff66";
                }

                let targetZ = CONFIG.ZOOM_MIN;
                if(earAvg > CONFIG.ZOOM_TRIGGER) targetZ = CONFIG.ZOOM_MAX;
                STATE.currentScale = (1 - 0.05) * STATE.currentScale + 0.05 * targetZ;
                document.getElementById('zoom-txt').innerText = Math.round(STATE.currentScale * 100) + "%";

                if(now - STATE.lastPageTime > 1500) {
                    if(earR < CONFIG.BLINK_THRESH && earL > CONFIG.OPEN_THRESH) {
                        changePage(1); STATE.lastPageTime = now;
                        document.getElementById('led-next').classList.add('blink-r'); setTimeout(()=>document.getElementById('led-next').classList.remove('blink-r'), 300);
                    } else if(earL < CONFIG.BLINK_THRESH && earR > CONFIG.OPEN_THRESH) {
                        changePage(-1); STATE.lastPageTime = now;
                        document.getElementById('led-prev').classList.add('blink-l'); setTimeout(()=>document.getElementById('led-prev').classList.remove('blink-l'), 300);
                    }
                }
            }
        }

        function completeStep(newLevel, currentEl, nextEl) {
            STATE.trainingStep = newLevel; currentEl.classList.remove('current'); currentEl.classList.add('done');
            if(nextEl) nextEl.classList.add('current'); speak("Validado.");
        }

        function toggleFreeze() {
            STATE.frozen = !STATE.frozen;
            if (STATE.frozen) {
                lockIcon.innerText = "üîí"; lockText.innerText = "TRAVADO"; lockText.style.color = "var(--locked)";
                topBar.classList.add('frozen'); speak("Sistema travado.");
            } else {
                lockIcon.innerText = "üîì"; lockText.innerText = "ATIVO"; lockText.style.color = "var(--success)";
                topBar.classList.remove('frozen'); speak("Sistema liberado.");
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            if(!STATE.active) return;
            document.getElementById('pdf-container').style.transform = `scale(${STATE.currentScale})`;
            if(Math.abs(STATE.targetScroll) > 0.1) document.getElementById('viewport').scrollTop += STATE.targetScroll;
        }

        function changePage(dir) {
            STATE.page += dir; if(STATE.page < 1) STATE.page = 1;
            pdfFrame.src = `${STATE.pdfUrl}#page=${STATE.page}`;
            document.getElementById('viewport').scrollTop = 0;
        }
    </script>
</body>
</html>
